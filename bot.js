const { Telegraf, Markup } = require('telegraf');
const fs = require('fs');
const path = require('path');

// الثوابت الأساسية
const TOKEN = process.env.TOKEN || "7733359265:AAFOs2Jqssu3T4oEnW0oPew7iPhK564PSUE";
const QUESTIONS = [
    { question: "ماهو ترتيب شهر رمضان في السنة الهجرية؟", options: ["7", "8", "9", "10"], answer: "9" },
    { question: "ما هو حكم صيام رمضان؟", options: ["مستحب", "واجب", "مكروه", "مباح"], answer: "واجب" },
    { question: "متى فرض الصيام على المسلمين؟", options: ["في السنة الأولى للهجرة", "في السنة الثانية للهجرة", "في السنة الثالثة للهجرة", "في السنة الرابعة للهجرة"], answer: "في السنة الثانية للهجرة" },
    { question: "كم كان عمر النبي ﷺ عندما فرض الصيام؟", options: ["35 سنة", "40 سنة", "45 سنة", "53 سنة"], answer: "53 سنة" },
    { question: "ما اسم الباب الذي يدخل منه الصائمون إلى الجنة؟", options: ["باب الجنة", "باب الريان", "باب الفردوس", "باب الرحمة"], answer: "باب الريان" },
    { question: "متى يبدأ يمسك الصائم يوفطر ؟", options: ["شروق الشمس إلى غروب الشمس", "أذان الفجر الأول إلى أذان المغرب", "أذان صلاة الفجر إلى أذان المغرب", "شروق الشمس إلى منتصف الليل"], answer: "أذان الفجر الأول إلى أذان المغرب" },
    { question: "وصف رمضان بوصف لم يرد في خطاب الشرع", options: ["غير جائز مطلقا", "جائز مطلقا", "جائز إذا صح معناه"], answer: "جائز إذا صح معناه" },
    { question: "بشارة التهنئة بقدوم رمضان", options: ["جائزة", "بدعة", "محرمة", "مكروهة"], answer: "جائزة" },
    { question: "فتح أبواب الجنة وغلق أبواب النار في رمضان", options: ["تفتح  وتغلق على حقيقتها", "لا تفتح ولا تغلق على حقيقتها", "تفتح أبواب الجنة فقط على حقيقتها ", "تغلق أبواب النار فقط على حقيقتها"], answer: "تفتح وتغلق على حقيقتها" },
    { question: "تصفيد الشياطين في رمضان تخص الشياطين عامة إلا ..", options: ["الشياطين المسترقة لسمع", "الشياطين العتاة", " الشيطان القرين", "كل ما سبق"], answer: "الشيطان القرين" },
    { question: "قول «إني صائم، إني صائم» لمن سابه أحد أو خاصمه", options: ["في صوم الفرض فقط", "في صوم النفل فقط", "في صوم الفرض والنفل", "لا تقال"], answer: "في صوم الفرض والنفل" },
    { question: "المسافر الذي لا يشق عليه الصوم", options: ["يكره له الصوم", "مخير والفطر أفضل", "مخير والصوم أفضل", "يكره له الفطر"], answer: "مخير والصوم أفضل" },
    { question: "من كان مرضه غير ميؤوس من زواله، ويشق عليه الصوم لكن لا يضره", options: ["يكره له الصوم", "يكره له الفطر", "يحرم عليه الصوم", "يجب عليه الصوم"], answer: "يكره له الصوم" },
    { question: "ماهي الإبر التي تفطر في رمضان؟", options: ["كل الإبر", "الإبر المغذية فقط", "الإبر الغير مغذية فقط", "الإبر لا تفطر"], answer: "الإبر المغذية فقط" },
    { question: "ماهي من الخيارات التالية المفطرة؟", options: ["السواك", "تحليل الدم", "وضع العطر", "الحجامة"], answer: "الحجامة" }
];
const USER_DATA_FILE = path.join(__dirname, 'user_data.json');
let userProgress = {};

// محتوى الأذكار الجديد
const AZKAR = {
    morning: [
        "🌕أَصْبَحْنَا وَأَصْبَحَ الْمُلْكُ لِلَّهِ وَالْحَمْدُ لِلَّهِ لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ . رَبِّ إنِّي أَسْأَلُكَ خَيْرَ مَا فِي هَذِاِ اليَوم وَخَيْرَ مَا بَعْدَهُ وَأَعُوذُ بِكَ مِنْ شَرِّ هَذِاِ اليَوم وَشَرِّ مَا بَعْدَهُ . رَبِّ أَعُوذُ بِكَ مِنْ عَذَابٍ فِي النَّارِ وَعَذَابٍ فِي الْقَبْرِ . ))\n📚(مختصر مسلم: 1894)",
        "🌕 - (( اللَّهُمَّ بِكَ أَصْبَحْنَا، وَبِكَ أَمْسَيْنَا، وَبِكَ نَحْيَا، وَبِكَ نَمُوتُ، وَإِلَيْكَ النُّشُورُ, ))\n📚(الصحيحة: 262) .",
        "🌕 - ((اللَّهُمَّ أَنْتَ رَبِّي، لاَ إِلَـهَ إِلاَّ أَنْتَ، خَلَقْتَنِي وَأَنَا عَبْدُكَ، وَأَنَا عَلَى عَهْدِكَ وَوَعْدِكَ مَا اسْتَطَعْتُ، أَعُوذُ بِكَ مِنْ شَرِّ مَا صَنَعْتُ, أَبُوءُ لَكَ بِنِعْمَتِكَ عَلَيَّ، وَأَبُوءُ لَكَ بِذَنْبِي، فَاغْفِرْ لِي؛ فَإِنَّهُ لاَ يَغْفِرُ الذُّنُوبَ إلاَّ أَنْتَ)) .\n📚(مختصر البخاري: 2420)",
        "🌕 - ((يَا حَيُّ يَا قَيُّومُ بِرَحْمَتِكَ أَسْتَغِيثُ, أَصْلِحْ لِي شَأْنِي كُلَّهُ, وَلاَ تَكِلْنِي إِلَى نَفْسِي طَرْفَةَ عَيْنٍ)) .\n📚(صحيح الترغيب: 661)",
        "🌕 - ((اللَّهُمّ عَالِمَ الْغَيْبِ وَالشَّهَادَةِ, فَاطِرَ السَّمَوَاتِ وَالأَرْضِ, رَبَّ كُلِّ شَيْءٍ وَمَلِيكَهُ، أشهد أن لا إله إلا أنت, أَعُوذُ بِكَ مِنْ شَرِّ نَفْسِي، وَشَرِّ الشَّيْطَانِ وَشَِرَْكِهِ, وَأَنْ أَقْتَرِفَ عَلَى نَفْسِي سُوءًا أَوْ أَجُرَّهُ إِلَى مُسْلِمٍ)) .\n📚(صحيح الكلم: 21)",
        "🌕 - ((اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَافِيَةَ فِي الدُّنْيَا وَالآخِرَةِ, اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَفْوَ وَالْعَافِيَةَ فِي دِينِي, وَدُنْيَايَ, وَأَهْلِي, وَمَالِي, اللَّهُمَّ اسْتُرْ عَوْرَاتِي وَآمِن رَّوْعَاتِي, اللَّهُمَّ احْفَظْنِي مِنْ بَيْنِ يَدَيَّ, وَمِن ْ خَلْفِي, وَعَنْ يَمِينِي, وَعَنْ شِمَالِي, وَمِنْ فَوْقِي، وَأَعُوذُ بِعَظَمَتِكَ أَنْ أُغْتَالَ مِنْ تَحْتِي)) .\n📚(صحيح الكلم: 23),(صحيح ابن ماجه: 3135)",
        "🌕- ((لاَ إِلَـهَ إِلاَّ اَللهُ وَحْدَهُ لاَ شَرِيكَ لَهُ, لَهُ الْمُلْكُ, وَلَهُ الْحَمْدُ, وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ)) .\n📚(صحيح الترغيب: 656),(صحيح الترمذي: 5077)",
        "🌕 - ((بِسْمِ اللهِ الَّذِي لاَ يَضُرُّ مَعَ اسْمِهِ شَيْءٌ؛ فِي الأَرْضِ وَلاَ فِي السَّمَاءِ وَهُوَ السَّمِيعُ الْعَلِيمُ)) .\nثلاث مرات .\n📚(صحيح الترمذي: 3388)",
        "🌕 - ((اللَّهُمَّ عَافِنِي فِي بَدَنِي، اللَّهُمَّ عَافِنِي فِي سَمْعِي، اللَّهُمَّ عَافِنِي فِي بَصَرِي، لاَ إِلَـهَ إلاَّ أَنْتَ, اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْكُفْرِ وَالْفَقْرِ، اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنْ عَذَابِ الْقَبْرِ، لاَ إِلَـهَ إلاَّ أَنْتَ)) .\nتعيدها ثلاثًا حين تصبح, وثلاثًا حين تُمسي .\n📚(صحيح أبي داود: 5090)",
        "🌕 - ((لاَ إِلَـهَ إِلاَّ اَللهُ وَحْدَهُ لاَ شَرِيكَ لَهُ, لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ يُحْيِي وَيُمِيتُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ)) .\nعشر مرات .\n📚(الصحيحة: 2563)",
        "🌕 - ((سُبْحَانَ اللهِ وَبِحَمْدِهِ)) .\nمائة مرة .\n📚(مختصر مسلم: 1903),(صحيح أبي داود: 5091)",
        "🌕 - ((سُبْحَانَ اللهِ)) .\nمائة مرة .\n((الحَمْدُ للهِ)) .\nمائة مرة .\n((اللهُ أكْبَرُ)) .\nمائة مرة .\n((لاَ إِلَـهَ إِلاَّ اَللهُ وَحْدَهُ لاَ شَرِيكَ لَهُ, لَهُ الْمُلْكُ, وَلَهُ الْحَمْدُ, وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ)) .\nمائة مرة .\n📚(صحيح الترغيب: 658)",
        "🌕 -( قُلْ :  قُلْ هُوَ اللَّهُ أَحَدٌ  ، وَالمُعَوِّذَتَيْنِ ، حِينَ تُمْسِي وَتُصْبِحُ ثَلاَثَ مَرَّاتٍ ، تَكْفِيكَ مِنْ كُلِّ شَيْءٍ )\n📚(صحيح الترمذي ).\n(وأبو داود )رقم/5082",
        "🌕 - آية الكرسيّ: ((اللّهُ لاَ إِلَهَ إِلاَّ هُوَ الْحَيُّ الْقَيُّومُ . . .)) .\n📚(صحيح الترغيب: 658)",
        "🌕- ((رَضِيتُ بِاللهِ رَبًّا, وَبِالإِسْلاَمِ دِينًا, وَبِمُحَمَّدٍ نَّبِيًّا)) .\n📚(الصحيحة: 2686)",
        "🌕 - ((أَصْبَحْنَا عَلَى فِطْرَةِ الإِسْلاَمِ، وَكَلِمَةِ الإِخْلاَصِ، وَدِينِ نَبِيِّنَا مُحَمَّدٍ، وَمِلَّةِ أَبِينَا إِبْرَاهِيمَ حَنِيفًا مُّسْلِمًا -وَمَا كَانَ مِنَ المُشْرِكِينَ-)) \n📚(الصحيحة: 2989),",
        "🌕- ((سُبْحَانَ اللهِ وبحمده عَدَدَ خَلْقِهِ, وَرِضَا نَفْسِهِ, وَزِنَةَ عَرْشِهِ, وَمِدَادَ كَلِمَاتِهِ)) .\nثلاث مرات .\n📚(الصحيحة: 2156)",
        "🌕 - ((ما أصبحت غَداةً قطُّ إلا استغفرت الله فيها مائة مرة)) .\n📚(الصحيحة: 1600)"
    ],
    evening: [
        "🌘1 - ((أَمسينا وَأَمسي الْمُلْكُ لِلَّهِ وَالْحَمْدُ لِلَّهِ لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ . رَبِّ إنِّي أَسْأَلُكَ خَيْرَ مَا فِي هَذِه الليلة وَخَيْرَ مَا بَعْدَهاُ وَأَعُوذُ بِكَ مِنْ شَرِّ هَذِاِ الليلة وَشَرِّ مَا بَعْدَهاُ . رَبِّ أَعُوذُ بِكَ مِنَ الْكَسَلِ وَسُوءِ الْكِبَرِ . رَبِّ أَعُوذُ بِكَ مِنْ عَذَابٍ فِي النَّارِ وَعَذَابٍ فِي الْقَبْرِ . ))\n(مختصر مسلم: 1894)",
        "🌘 - (( اللَّهُمَّ بِكَ أَمسينَا، وَبِكَ أَصبحنَا، وَبِكَ نَحْيَا، وَبِكَ نَمُوتُ، وَإِلَيْكَ المصيرُ , ))\n(الصحيحة: 262) .",
        "🌘 - ((اللَّهُمَّ أَنْتَ رَبِّي،لاَ إِلَـهَ إِلاَّ أَنْتَ خَلَقْتَنِي وَأَنَا عَبْدُكَ وَأَنَا عَلَى عَهْدِكَ وَوَعْدِكَ مَا اسْتَطَعْتُ، أَعُوذُ بِكَ مِنْ شَرِّ مَا صَنَعْتُ, أَبُوءُ لَكَ بِنِعْمَتِكَ عَلَيَّ، وَأَبُوءُ لَكَ بِذَنْبِي، فَاغْفِرْ لِي؛ فَإِنَّهُ لاَ يَغْفِرُ الذُّنُوبَ إلاَّ أَنْتَ)) .\n(مختصر البخاري: 2420)",
        "🌘 - ((يَا حَيُّ يَا قَيُّومُ بِرَحْمَتِكَ أَسْتَغِيثُ, أَصْلِحْ لِي شَأْنِي كُلَّهُ, وَلاَ تَكِلْنِي إِلَى نَفْسِي طَرْفَةَ عَيْنٍ)) .\n(صحيح الترغيب: 661)",
        "🌘- ((اللَّهُمّ عَالِمَ الْغَيْبِ وَالشَّهَادَةِ, فَاطِرَ السَّمَوَاتِ وَالأَرْضِ, رَبَّ كُلِّ شَيْءٍ وَمَلِيكَهُ، أشهد أن لا إله إلا أنت, أَعُوذُ بِكَ مِنْ شَرِّ نَفْسِي، وَشَرِّ الشَّيْطَانِ وَشَِرَْكِهِ, وَأَنْ أَقْتَرِفَ عَلَى نَفْسِي سُوءًا أَوْ أَجُرَّهُ إِلَى مُسْلِمٍ)) .\n(صحيح الكلم: 21)",
        "🌘 - ((اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَافِيَةَ فِي الدُّنْيَا وَالآخِرَةِ, اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَفْوَ وَالْعَافِيَةَ فِي دِينِي, وَدُنْيَايَ, وَأَهْلِي, وَمَالِي, اللَّهُمَّ اسْتُرْ عَوْرَاتِي وَآمِن رَّوْعَاتِي, اللَّهُمَّ احْفَظْنِي مِنْ بَيْنِ يَدَيَّ, وَمِن ْ خَلْفِي, وَعَنْ يَمِينِي, وَعَنْ شِمَالِي, وَمِنْ فَوْقِي، وَأَعُوذُ بِعَظَمَتِكَ أَنْ أُغْتَالَ مِنْ تَحْتِي)) .\n(صحيح الكلم: 23),(صحيح ابن ماجه: 3135)",
        "🌘- ((لاَ إِلَـهَ إِلاَّ اَللهُ وَحْدَهُ لاَ شَرِيكَ لَهُ, لَهُ الْمُلْكُ, وَلَهُ الْحَمْدُ, وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ)) .\n(صحيح الترغيب: 656),(صحيح الترمذي: 5077)",
        "🌘 - ((بِسْمِ اللهِ الَّذِي لاَ يَضُرُّ مَعَ اسْمِهِ شَيْءٌ؛ فِي الأَرْضِ وَلاَ فِي السَّمَاءِ وَهُوَ السَّمِيعُ الْعَلِيمُ)) .\nثلاث مرات .\n(صحيح الترمذي: 3388)",
        "🌘 - ((اللَّهُمَّ عَافِنِي فِي بَدَنِي، اللَّهُمَّ عَافِنِي فِي سَمْعِي، اللَّهُمَّ عَافِنِي فِي بصري لاإله إلاَّ أَنْتَ, اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْكُفْرِ وَالْفَقْرِ، اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنْ عَذَابِ الْقَبْرِ، لاَ إِلَـهَ إلاَّ أَنْتَ)) .\nتعيدها ثلاثًا حين تصبح, وثلاثًا حين تُمسي .\n(صحيح أبي داود: 5090)",
        "🌘 - ((لاَ إِلَـهَ إِلاَّ اَلاللهُ وَحْدَهُ لاَ شَرِيكَ لَهُ, لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ يُحْيِي وَيُمِيتُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ)) .\nعشر مرات .\n(الصحيحة: 2563)",
        "🌘 - ((سُبْحَانَ اللهِ وَبِحَمْدِهِ)) .\nمائة مرة .\n(مختصر مسلم: 1903),(صحيح أبي داود: 5091)",
        "🌘 - ((سُبْحَانَ اللهِ)) .\nمائة مرة .\n((الحَمْدُ للهِ)) .\nمائة مرة .\n((اللهُ أكْبَرُ)) .\nمائة مرة .\n((لاَ إِلَـهَ إِلاَّ اَللهُ وَحْدَهُ لاَ شَرِيكَ لَهُ, لَهُ الْمُلْكُ, وَلَهُ الْحَمْدُ, وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ)) .\nمائة مرة .\n(صحيح الترغيب: 658)",
        "🌘 -( قُلْ :  قُلْ هُوَ اللَّهُ أَحَدٌ  ، وَالمُعَوِّذَتَيْنِ ، حِينَ تُمْسِي وَتُصْبِحُ ثَلاَثَ مَرَّاتٍ ، تَكْفِيكَ مِنْ كُلِّ شَيْءٍ )\n(صحيح الترمذي ).\n(وأبو داود )رقم/5082",
        "🌘 - آية الكرسيّ: ((اللّهُ لاَ إِلَهَ إِلاَّ هُوَ الْحَيُّ الْقَيُّومُ . . .)) .\n(صحيح الترغيب: 658)",
        "🌘- ((رَضِيتُ بِاللهِ رَبًّا, وَبِالإِسْلاَمِ دِينًا, وَبِمُحَمَّدٍ نَّبِيًّا)) .\n(الصحيحة: 2686),(الضعيفة تحت رقم: 5020)",
        "🌘 - ((أَمسينا عَلَى فِطْرَةِ الإِسْلاَمِ، وَكَلِمَةِ الإِخْلاَصِ، وَدِينِ نَبِيِّنَا مُحَمَّدٍ، وَمِلَّةِ أَبِينَا إِبْرَاهِيمَ حَنِيفًا مُّسْلِمًا -وَمَا كَانَ مِنَ المُشْرِكِينَ-)) .\n(الصحيحة: 2989),(تراجع العلامة: 370)",
        "🌘 - ((سُبْحَانَ اللهِ وبحمده عَدَدَ خَلْقِهِ, وَرِضَا نَفْسِهِ, وَزِنَةَ عَرْشِهِ, وَمِدَادَ كَلِمَاتِهِ)) .\nثلاث مرات .\n(الصحيحة: 2156)"
    ]
};

// ---- دوال إدارة البيانات ----
function loadUserData() {
    try {
        if (fs.existsSync(USER_DATA_FILE)) {
            const data = fs.readFileSync(USER_DATA_FILE, 'utf8');
            userProgress = JSON.parse(data) || {};
        }
    } catch (error) {
        console.error('خطأ في تحميل البيانات:', error);
        userProgress = {};
    }
}

function saveUserData() {
    try {
        fs.writeFileSync(USER_DATA_FILE, JSON.stringify(userProgress, null, 2));
    } catch (error) {
        console.error('خطأ في حفظ البيانات:', error);
    }
}

// ---- إدارة الرسائل ----
async function deletePreviousMessages(ctx) {
    const userId = ctx.from?.id;
    if (!userId || !userProgress[userId]?.messageIds?.length) return;

    try {
        const validMessages = userProgress[userId].messageIds
            .filter(id => typeof id === 'number' && id > 0);
        
        await Promise.all(
            validMessages.map(msgId => 
                ctx.telegram.deleteMessage(ctx.chat?.id, msgId)
                    .catch(e => console.error(`تعذر حذف الرسالة ${msgId}:`, e.message))
            )
        );
    } finally {
        userProgress[userId].messageIds = [];
        saveUserData();
    }
}

async function sendManagedMessage(ctx, text, keyboard) {
    await deletePreviousMessages(ctx);
    const message = await ctx.reply(text, keyboard);
    
    const userId = ctx.from.id;
    if (!userProgress[userId]) userProgress[userId] = { messageIds: [] };
    userProgress[userId].messageIds.push(message.message_id);
    
    saveUserData();
    return message;
}

// ---- نظام القوائم ----
async function start(ctx) {
    await sendManagedMessage(
        ctx,
        "مرحبًا بك! 👋\nاضغط على Start للبدء.",
        Markup.keyboard([["Start"]]).resize()
    );
}

async function mainMenu(ctx) {
    return sendManagedMessage(
        ctx,
        "🏠 القائمة الرئيسية:",
        Markup.keyboard([
            ["❓ الأسئلة", "🕌 الأذكار"],
            ["📖 القرآن الكريم", "🎧 التلاوات"],
            ["🔙 رجوع"]
        ]).resize()
    );
}

// ---- نظام الأذكار ----
async function showAzkarMenu(ctx) {
    return sendManagedMessage(
        ctx,
        "🕌 اختر نوع الأذكار:",
        Markup.keyboard([
            ["🌅 أذكار الصباح", "🌃 أذكار المساء"],
            ["🔙 رجوع"]
        ]).resize()
    );
}

async function showAzkarContent(ctx, type, index = 0) {
    if (index >= AZKAR[type].length) {
        return showAzkarMenu(ctx);
    }

    const buttonText = index === AZKAR[type].length - 1 ? "🕌 قائمة الأذكار" : "➡️ التالي";
    
    return sendManagedMessage(
        ctx,
        `${AZKAR[type][index]}`,
        Markup.inlineKeyboard([
            Markup.button.callback(buttonText, `azkar_${type}_${index + 1}`),
            Markup.button.callback("🔙 عودة", `back_to_${type}_menu`)
        ])
    );
}

// ---- نظام الأسئلة ----
async function startQuiz(ctx) {
    const userId = ctx.from.id;
    userProgress[userId] = {
        quiz: {
            currentQuestion: 0,
            attempts: {},
            correctAnswers: 0 // تتبع الإجابات الصحيحة
        },
        messageIds: []
    };
    await showNextQuestion(ctx, userId);
}

async function showNextQuestion(ctx, userId) {
    try {
    const { quiz } = userProgress[userId];
    const { currentQuestion } = quiz;

    if (currentQuestion >= QUESTIONS.length) {
        const score = quiz.correctAnswers || 0; // قيمة افتراضية لتجنب NaN
        const totalQuestions = QUESTIONS.length;
        const resultMessage = `🎉 لقد أكملت جميع الأسئلة بنجاح!\nنتيجتك: ${score} / ${totalQuestions}`;

        return sendManagedMessage(
            ctx,
            resultMessage,
            Markup.inlineKeyboard([
                Markup.button.callback("🏠 العودة للقائمة الرئيسية", "back_to_main")
            ])
        );
    }

    const question = QUESTIONS[currentQuestion];
   const keyboard = Markup.inlineKeyboard(
            question.options.map(opt => [Markup.button.callback(opt, `q_${currentQuestion}_ans_${opt}`)] )
        );
    const attempts = userProgress[userId].quiz.attempts[currentQuestion] || 3;

    return sendManagedMessage(
        ctx,
        `السؤال ${currentQuestion + 1}:\n${question.question}\n(لديك ${attempts} محاولات)`,
       keyboard
    );
} catch (error) {
        console.error('حدث خطأ  اثناء عرض السؤال التالي:', error);
        ctx.replyWithHTML("⚠️ حدث خطأ غير متوقع، يرجى المحاولة لاحقًا.");
    }
}

// ---- تهيئة البوت ----
const bot = new Telegraf(TOKEN);
loadUserData();

// ---- معالجة الأحداث ----
bot.start(start);
bot.hears("Start", mainMenu);

bot.hears("❓ الأسئلة", startQuiz);
bot.hears("🕌 الأذكار", showAzkarMenu);

bot.hears("📖 القرآن الكريم", async ctx => {
    await ctx.reply("📖 هذا المحتوى غير متوفر حاليًا 💔🫶", Markup.keyboard([
        ["❓ الأسئلة", "🕌 الأذكار"],
        ["📖 القرآن الكريم", "🎧 التلاوات"],
        ["🔙 رجوع"]
    ]).resize());
});

bot.hears("🎧 التلاوات", async ctx => {
    await ctx.reply("🎧 هذا المحتوى غير متوفر حاليًا 💔🫶", Markup.keyboard([
        ["❓ الأسئلة", "🕌 الأذكار"],
        ["📖 القرآن الكريم", "🎧 التلاوات"],
        ["🔙 رجوع"]
    ]).resize());
});

//معالجة القوائم 
bot.hears("🌅 أذكار الصباح", ctx => showAzkarContent(ctx, 'morning'));
bot.hears("🌃 أذكار المساء", ctx => showAzkarContent(ctx, 'evening'));
bot.action(/back_to_(morning|evening)_menu/, showAzkarMenu);
bot.action("back_to_azkar_menu", showAzkarMenu);

//معالجة الاذكار نفسها
bot.action(/azkar_(morning|evening)_(\d+)/, async (ctx) => {
    const type = ctx.match[1];
    const index = parseInt(ctx.match[2]);
    await showAzkarContent(ctx, type, index);
});

//معالجة زر الرجوع الرئيسي
bot.hears("🔙 رجوع", mainMenu);

// معالجة الإجابات
bot.action(/q_(\d+)_ans_(.+)/, async (ctx) => {
    try {
    const userId = ctx.from.id;
    const questionIndex = parseInt(ctx.match[1]);
    const answer = ctx.match[2];
    const { quiz } = userProgress[userId];
    const question = QUESTIONS[questionIndex];

    // تهيئة المحاولات إذا لم تكن موجودة
    if (!userProgress[userId].quiz.attempts[questionIndex]) {
        userProgress[userId].quiz.attempts[questionIndex] = 3;
    }

    userProgress[userId].quiz.attempts[questionIndex]--;
    const attemptsLeft = userProgress[userId].quiz.attempts[questionIndex];

    await deletePreviousMessages(ctx);

    if (answer === question.answer) {
        quiz.correctAnswers++; // زيادة عدد الإجابات الصحيحة
        quiz.currentQuestion++;
        delete userProgress[userId].quiz.attempts[questionIndex]; // حذف المحاولات عند الإجابة الصحيحة
        const correctMessage = await ctx.replyWithHTML("✅ <b>إجابة صحيحة!</b>");
        setTimeout(() => ctx.deleteMessage(correctMessage.message_id), 1000);
        await showNextQuestion(ctx, userId);
    } else {
        if (attemptsLeft === 0) {
            const replyText = `لقد إستنفذت جميع محاولاتك للإجابة على هذا السؤال 💔، الإجابة الصحيحة هي: ${question.answer}`;
            const keyboard = Markup.inlineKeyboard([
                Markup.button.callback("➡️ التالي", "next_question")
            ]);

            await sendManagedMessage(ctx, replyText, keyboard);
        } else {
            const replyText = `❌ إجابة خاطئة! (تبقى ${attemptsLeft} محاولات)`;
            const keyboard = Markup.inlineKeyboard([
                Markup.button.callback("🔄 إعادة المحاولة", `q_${questionIndex}_retry`)
            ]);
            await sendManagedMessage(ctx, replyText, keyboard);
        }
    }
    saveUserData();
       } catch (error) {
        console.error('حدث خطأ أثناء معالجة الإجابة:', error);
        ctx.replyWithHTML("⚠️ حدث خطأ غير متوقع، يرجى المحاولة لاحقًا.");
    }
});

bot.action(/q_(\d+)_retry/, async (ctx) => {
     try {
    const userId = ctx.from.id;
    const questionIndex = parseInt(ctx.match[1]);
    userProgress[userId].quiz.currentQuestion = questionIndex;
    await showNextQuestion(ctx, userId);
      }  catch (error) {
        console.error('حدث خطأ اثناء عمل ريتري:', error);
        ctx.replyWithHTML("⚠️ حدث خطأ غير متوقع، يرجى المحاولة لاحقًا.");
    }
});

bot.action("next_question", async (ctx) => {
   const userId = ctx.from.id;
    const { quiz } = userProgress[userId];
    quiz.currentQuestion++;
    showNextQuestion(ctx, userId);
});

bot.action("back_to_main", mainMenu);

// معالجة الأخطاء
bot.catch((err, ctx) => {
    console.error('حدث خطأ غير متوقع:', err);
    ctx.replyWithHTML("⚠️ حدث خطأ غير متوقع، يرجى المحاولة لاحقًا.");
});

// التشغيل
bot.launch()
    .then(() => console.log("✅ البوت يعمل بنجاح"))
    .catch(err => console.error("❌ فشل التشغيل:", err));

process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));

